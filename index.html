<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>Shadow Hunter - Mobile Souls</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      body {
        margin: 0;
        overflow: hidden;
        background-color: #000;
        font-family: "Consolas", monospace;
        touch-action: none;
        -webkit-tap-highlight-color: transparent;
      }
      canvas {
        display: block;
      }
      #ui-layer {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
      }
      .interactive {
        pointer-events: auto;
      }

      /* Joystick Styles - Izquierda Abajo */
      #joystick-container {
        position: absolute;
        bottom: 50px;
        left: 40px;
        width: 120px;
        height: 120px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 50%;
        border: 2px solid rgba(255, 255, 255, 0.2);
        z-index: 10;
      }
      #joystick-knob {
        position: absolute;
        top: 35px;
        left: 35px;
        width: 50px;
        height: 50px;
        background: #ffaa00;
        border-radius: 50%;
        box-shadow: 0 0 15px rgba(255, 170, 0, 0.5);
      }

      /* Actions Container - Derecha Abajo */
      #actions-container {
        position: absolute;
        bottom: 50px;
        right: 40px;
        display: flex;
        gap: 20px;
        align-items: center;
        z-index: 10;
      }

      /* Action Buttons */
      .action-btn {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.1);
        border: 2px solid #ffaa00;
        display: flex;
        items-center: justify-center;
        color: #ffaa00;
        font-weight: bold;
        font-size: 14px;
        transition: all 0.1s;
      }
      .action-btn:active,
      .btn-active {
        background: #ffaa00;
        color: #000;
        transform: scale(0.95);
      }
      .btn-disabled {
        opacity: 0.3;
        border-color: #555;
        color: #555;
        pointer-events: none;
      }

      /* Bot贸n Dash m谩s peque帽o */
      .skill-btn-style {
        width: 60px;
        height: 60px;
        font-size: 10px;
        border-color: #00aaff;
        color: #00aaff;
      }

      .stat-btn {
        background: #444;
        color: #fff;
        padding: 4px 12px;
        border-radius: 4px;
        font-weight: bold;
      }
      .quest-card {
        background: rgba(10, 10, 10, 0.95);
        border: 1px solid #ffaa00;
        box-shadow: 0 0 20px rgba(0, 0, 0, 1);
      }

      /* Damage Text Animation */
      .damage-text {
        position: absolute;
        color: red;
        font-weight: bold;
        font-size: 20px;
        pointer-events: none;
        animation: floatUp 1s forwards;
        text-shadow: 1px 1px 0 #000;
      }
      .xp-text {
        position: absolute;
        color: gold;
        font-weight: bold;
        font-size: 20px;
        pointer-events: none;
        animation: floatUp 1.5s forwards;
        text-shadow: 1px 1px 0 #000;
      }
      @keyframes floatUp {
        0% {
          opacity: 1;
          transform: translateY(0);
        }
        100% {
          opacity: 0;
          transform: translateY(-50px);
        }
      }
    </style>
  </head>
  <body>
    <div id="ui-layer">
      <!-- Men煤 Principal -->
      <div
        id="lobby"
        class="flex flex-col items-center justify-center h-full bg-slate-900 interactive"
      >
        <h1 class="text-4xl mb-2 font-black text-white italic tracking-tighter">
          SHADOW HUNTER
        </h1>
        <p class="text-yellow-500 mb-8 font-bold text-[10px] tracking-[0.2em]">
          MOBILE BATTLE RPG
        </p>

        <div class="flex flex-col gap-4 w-64">
          <button
            onclick="startGame('WARRIOR')"
            class="bg-black border-2 border-red-700 p-4 text-white hover:bg-red-900 transition-all"
          >
            <span class="block font-bold">ESPADACHN</span>
            <span class="text-[10px] text-red-400">DASH & FUERZA</span>
          </button>
          <button
            onclick="startGame('SCOUT')"
            class="bg-black border-2 border-green-700 p-4 text-white hover:bg-green-900 transition-all"
          >
            <span class="block font-bold">TIRADOR</span>
            <span class="text-[10px] text-green-400">VELOCIDAD & DUALS</span>
          </button>
        </div>
        <div class="mt-8 text-gray-500 text-[10px] text-center">
          <p class="mb-2">CONTROLES PC</p>
          <p>WASD: Mover | ESPACIO: Dash (Lvl 2+)</p>
          <p>ENTER / CLICK: Atacar</p>
        </div>
        <button
          onclick="toggleFullScreen()"
          class="mt-4 text-yellow-600 text-[10px] underline"
        >
          PANTALLA COMPLETA
        </button>
      </div>

      <!-- HUD M贸vil -->
      <div
        id="hud"
        class="hidden h-full w-full flex flex-col justify-between p-4"
      >
        <!-- Superior: HP y Niveles -->
        <div class="flex justify-between items-start">
          <div class="flex flex-col gap-1">
            <div class="flex items-center gap-2">
              <div
                class="w-40 h-4 bg-gray-900 border border-gray-700 overflow-hidden relative"
              >
                <div
                  id="hp-bar"
                  class="h-full bg-red-600 transition-all duration-200"
                  style="width: 100%"
                ></div>
                <span
                  id="hp-text"
                  class="absolute inset-0 text-[10px] text-white flex items-center justify-center font-bold"
                  >100/100</span
                >
              </div>
            </div>
            <div class="flex items-center gap-2">
              <div
                class="w-32 h-2 bg-gray-900 border border-gray-700 overflow-hidden"
              >
                <div
                  id="stamina-bar"
                  class="h-full bg-green-600"
                  style="width: 100%"
                ></div>
              </div>
            </div>
            <div class="text-[10px] text-yellow-500 font-bold mt-1">
              LVL <span id="lvl-val">1</span> | ALMAS:
              <span id="xp-val">0</span>
            </div>
          </div>

          <button
            onclick="toggleStats()"
            class="interactive bg-black/50 border border-yellow-600 p-2 text-yellow-500 text-[10px] font-bold hover:bg-black"
          >
            ATRIBUTOS
          </button>
        </div>

        <!-- Centro: Panel de Atributos (Modal M贸vil) -->
        <div
          id="attr-panel"
          class="hidden self-center bg-black/90 border-2 border-yellow-600 p-6 text-white interactive w-72"
        >
          <div class="flex justify-between mb-4">
            <h3 class="font-bold text-sm uppercase">Mejorar Personaje</h3>
            <button onclick="toggleStats()" class="text-red-500 font-bold">
              X
            </button>
          </div>
          <div class="flex flex-col gap-4">
            <div class="flex justify-between items-center">
              <span>VIGOR (HP)</span>
              <div class="flex items-center gap-4">
                <span id="stat-vig">10</span>
                <button onclick="upgradeStat('vig')" class="stat-btn">+</button>
              </div>
            </div>
            <div class="flex justify-between items-center">
              <span>FUERZA (DMG)</span>
              <div class="flex items-center gap-4">
                <span id="stat-str">10</span>
                <button onclick="upgradeStat('str')" class="stat-btn">+</button>
              </div>
            </div>
            <div class="flex justify-between items-center">
              <span>DESTREZA (SPD)</span>
              <div class="flex items-center gap-4">
                <span id="stat-dex">10</span>
                <button onclick="upgradeStat('dex')" class="stat-btn">+</button>
              </div>
            </div>
            <p class="text-[10px] text-yellow-600 text-center mt-2">
              COSTO: 100 ALMAS
            </p>
          </div>
        </div>

        <!-- Inferior: Controles T谩ctiles (Posicionamiento Absoluto) -->

        <!-- Joystick Izquierda -->
        <div id="joystick-container" class="interactive">
          <div id="joystick-knob"></div>
        </div>

        <!-- Botones Derecha -->
        <div id="actions-container" class="interactive">
          <div class="relative">
            <button
              id="skill-btn"
              onpointerdown="triggerSkill()"
              class="action-btn skill-btn-style btn-disabled"
            >
              DASH
            </button>
            <span
              id="lock-icon"
              class="absolute -top-2 -right-2 bg-red-600 text-white text-[10px] px-1 rounded-full"
              > Lvl 2</span
            >
          </div>
          <button
            id="attack-btn"
            onpointerdown="triggerAttack()"
            class="action-btn"
            style="border-color: #ff4400; color: #ff4400"
          >
            ATK
          </button>
        </div>

        <!-- Modal de Quest -->
        <div
          id="quest-notifier"
          class="hidden absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 quest-card p-6 interactive w-[85%] max-w-sm text-white z-50"
        >
          <p
            id="quest-title"
            class="text-yellow-500 font-bold text-lg mb-2 italic"
          ></p>
          <p id="quest-desc" class="text-xs text-gray-400 mb-6"></p>
          <div class="flex gap-2">
            <button
              onclick="acceptQuest()"
              class="flex-1 bg-yellow-600 text-black font-bold py-3 text-sm hover:bg-yellow-500"
            >
              ACEPTAR PODER
            </button>
            <button
              onclick="closeQuest()"
              class="px-4 bg-gray-800 text-white font-bold py-3 text-sm hover:bg-gray-700"
            >
              IGNORAR
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      let scene, camera, renderer, player, clock;
      let enemies = [];
      let worldSize = 120;
      let isGameRunning = false;
      let currentCamp = null;
      let keys = {};

      // Estado del Jugador
      let playerStats = {
        lvl: 1,
        xp: 0,
        vig: 10,
        str: 10,
        dex: 10,
        hp: 100,
        maxHp: 100,
        stamina: 100,
        maxStamina: 100,
        role: "WARRIOR",
      };

      // Control de Joystick
      let joystick = { active: false, x: 0, y: 0, startX: 0, startY: 0 };
      const ROLES = {
        WARRIOR: {
          color: 0x990000,
          speed: 0.12,
          skillName: "DASH",
          baseDmg: 15,
        },
        SCOUT: {
          color: 0x009900,
          speed: 0.16,
          skillName: "SPRINT",
          baseDmg: 10,
        },
      };

      function toggleFullScreen() {
        if (!document.fullscreenElement) {
          document.documentElement.requestFullscreen().catch((e) => {});
        } else {
          document.exitFullscreen();
        }
      }

      function initScene() {
        scene = new THREE.Scene();
        scene.background = new THREE.Color(0x0a0a0a);
        scene.fog = new THREE.FogExp2(0x0a0a0a, 0.04);
        camera = new THREE.PerspectiveCamera(
          60,
          window.innerWidth / window.innerHeight,
          0.1,
          1000
        );
        renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        document.body.appendChild(renderer.domElement);

        // Luces
        const amb = new THREE.AmbientLight(0xffffff, 0.2);
        scene.add(amb);
        const dir = new THREE.DirectionalLight(0xffaa00, 0.8);
        dir.position.set(50, 100, 20);
        dir.castShadow = true;
        scene.add(dir);

        createWorld();
        setupInput();
      }

      function createWorld() {
        const floorGeo = new THREE.PlaneGeometry(worldSize, worldSize);
        const floorMat = new THREE.MeshStandardMaterial({
          color: 0x111111,
          roughness: 0.8,
        });
        const floor = new THREE.Mesh(floorGeo, floorMat);
        floor.rotation.x = -Math.PI / 2;
        scene.add(floor);

        // Grid decorativo
        const grid = new THREE.GridHelper(worldSize, 20, 0x333333, 0x222222);
        grid.position.y = 0.01;
        scene.add(grid);

        // Obst谩culos
        for (let i = 0; i < 40; i++) {
          const h = 4 + Math.random() * 6;
          const w = 2 + Math.random() * 2;
          const m = new THREE.Mesh(
            new THREE.BoxGeometry(w, h, w),
            new THREE.MeshStandardMaterial({ color: 0x222222 })
          );
          m.position.set(
            (Math.random() - 0.5) * worldSize,
            h / 2,
            (Math.random() - 0.5) * worldSize
          );
          m.userData = { isObstacle: true, radius: w / 1.5 }; // Para colisiones
          scene.add(m);
        }

        for (let i = 0; i < 8; i++)
          spawnCamp(
            (Math.random() - 0.5) * 100,
            (Math.random() - 0.5) * 100,
            i
          );
      }

      function spawnCamp(x, z, id) {
        const group = new THREE.Group();
        const fire = new THREE.Mesh(
          new THREE.CylinderGeometry(1.5, 2, 0.5, 8),
          new THREE.MeshBasicMaterial({ color: 0x442200 })
        );
        const light = new THREE.PointLight(0xff4400, 2, 10);
        light.position.y = 1;
        group.add(fire);
        group.add(light);

        // Part铆cula de fuego simple
        const flame = new THREE.Mesh(
          new THREE.SphereGeometry(0.5, 4, 4),
          new THREE.MeshBasicMaterial({ color: 0xffaa00 })
        );
        flame.position.y = 0.5;
        group.add(flame);

        group.position.set(x, 0.25, z);
        group.userData = { isCamp: true, id: id, used: false };
        scene.add(group);
      }

      function createCharacter(role, isEnemy = false) {
        const group = new THREE.Group();
        const col = isEnemy
          ? Math.random() > 0.5
            ? ROLES.WARRIOR.color
            : ROLES.SCOUT.color
          : ROLES[role].color;

        const body = new THREE.Mesh(
          new THREE.CylinderGeometry(0.5, 0.5, 1.5, 8),
          new THREE.MeshStandardMaterial({ color: col })
        );
        body.position.y = 0.75;
        group.add(body);

        const head = new THREE.Mesh(
          new THREE.SphereGeometry(0.35, 8, 8),
          new THREE.MeshStandardMaterial({ color: 0xffffff })
        );
        head.position.set(0, 1.6, 0.2);
        group.add(head);

        // Barra de vida para enemigos
        if (isEnemy) {
          const hpBg = new THREE.Mesh(
            new THREE.PlaneGeometry(1, 0.1),
            new THREE.MeshBasicMaterial({ color: 0x000000 })
          );
          hpBg.position.set(0, 2.2, 0);
          group.add(hpBg);
          const hpFg = new THREE.Mesh(
            new THREE.PlaneGeometry(1, 0.1),
            new THREE.MeshBasicMaterial({ color: 0xff0000 })
          );
          hpFg.position.set(0, 2.2, 0.01);
          group.userData.hpBar = hpFg;
          group.add(hpFg);
        }

        group.position.set(
          (Math.random() - 0.5) * 80,
          0,
          (Math.random() - 0.5) * 80
        );

        if (isEnemy) {
          // Stats del enemigo (simulando jugadores)
          const lvl = 1 + Math.floor(Math.random() * 3);
          group.userData = {
            isEnemy: true,
            hp: 80 + lvl * 20,
            maxHp: 80 + lvl * 20,
            xpReward: 50 * lvl,
            targetPos: new THREE.Vector3(
              (Math.random() - 0.5) * 100,
              0,
              (Math.random() - 0.5) * 100
            ),
          };
        }

        scene.add(group);
        return group;
      }

      function setupInput() {
        // Joystick
        const container = document.getElementById("joystick-container");
        const knob = document.getElementById("joystick-knob");

        const handleStart = (e) => {
          joystick.active = true;
          const touch = e.touches ? e.touches[0] : e;
          const rect = container.getBoundingClientRect();
          joystick.startX = rect.left + rect.width / 2;
          joystick.startY = rect.top + rect.height / 2;
        };

        const handleMove = (e) => {
          if (!joystick.active) return;
          const touch = e.touches ? e.touches[0] : e;
          const dx = touch.clientX - joystick.startX;
          const dy = touch.clientY - joystick.startY;
          const dist = Math.min(Math.sqrt(dx * dx + dy * dy), 50);
          const angle = Math.atan2(dy, dx);

          joystick.x = (Math.cos(angle) * dist) / 50;
          joystick.y = (Math.sin(angle) * dist) / 50;

          knob.style.transform = `translate(${joystick.x * 50}px, ${
            joystick.y * 50
          }px)`;
        };

        const handleEnd = () => {
          joystick.active = false;
          joystick.x = 0;
          joystick.y = 0;
          knob.style.transform = "translate(0,0)";
        };

        container.addEventListener("touchstart", handleStart);
        window.addEventListener("touchmove", handleMove);
        window.addEventListener("touchend", handleEnd);

        // Teclado (PC)
        window.addEventListener("keydown", (e) => {
          keys[e.code] = true;
          if (e.code === "Space") triggerSkill();
          if (e.code === "Enter") triggerAttack();
        });
        window.addEventListener("keyup", (e) => (keys[e.code] = false));

        // Mouse Click Attack
        window.addEventListener("mousedown", (e) => {
          // Solo si no estamos tocando UI
          if (e.target.tagName !== "BUTTON") triggerAttack();
        });
      }

      function startGame(role) {
        document.getElementById("lobby").classList.add("hidden");
        document.getElementById("hud").classList.remove("hidden");
        document.getElementById("skill-btn").innerText = ROLES[role].skillName;

        player = createCharacter(role);
        player.userData.radius = 0.5; // Hitbox del jugador
        playerStats.role = role;

        isGameRunning = true;

        for (let i = 0; i < 9; i++) {
          enemies.push(createCharacter("WARRIOR", true));
        }
        updateHUD();
        animate();
      }

      // Acciones
      function triggerSkill() {
        if (!isGameRunning) return;

        // Restricci贸n de Nivel
        if (playerStats.lvl < 2) {
          showFloatingText("隆Necesitas Nivel 2!", player.position, "red");
          return;
        }

        if (playerStats.stamina >= 40) {
          playerStats.stamina -= 40;
          // Visual Dash
          const dashMesh = player.children[0].clone();
          dashMesh.material = dashMesh.material.clone();
          dashMesh.material.transparent = true;
          dashMesh.material.opacity = 0.5;
          dashMesh.position.copy(player.position);
          scene.add(dashMesh);
          setTimeout(() => scene.remove(dashMesh), 200);

          // Boost
          const dir = new THREE.Vector3(0, 0, 1).applyQuaternion(
            player.quaternion
          );
          player.position.addScaledVector(dir, 5); // Teleport corto
        }
      }

      function triggerAttack() {
        if (!isGameRunning) return;

        // Animaci贸n visual del bot贸n
        const btn = document.getElementById("attack-btn");
        btn.classList.add("btn-active");
        setTimeout(() => btn.classList.remove("btn-active"), 100);

        if (playerStats.stamina < 10) return;
        playerStats.stamina -= 10;

        // Visual Attack (Onda)
        const wave = new THREE.Mesh(
          new THREE.RingGeometry(0.5, 2.5, 3),
          new THREE.MeshBasicMaterial({
            color: 0xffaa00,
            transparent: true,
            opacity: 0.8,
            side: THREE.DoubleSide,
          })
        );
        wave.rotation.x = -Math.PI / 2;
        wave.position.copy(player.position);
        wave.position.y = 0.5;
        // Ajustar rotaci贸n para coincidir con el jugador
        wave.quaternion.copy(player.quaternion);
        wave.rotateX(-Math.PI / 2); // Corregir orientaci贸n del plano

        scene.add(wave);
        setTimeout(() => scene.remove(wave), 150);

        // L贸gica de Hitbox (Cono frontal)
        const attackRange = 3;
        const attackAngle = Math.PI / 2; // 90 grados
        const playerDir = new THREE.Vector3(0, 0, 1)
          .applyQuaternion(player.quaternion)
          .normalize();

        enemies.forEach((enemy, index) => {
          const dist = player.position.distanceTo(enemy.position);
          if (dist < attackRange) {
            const enemyDir = new THREE.Vector3()
              .subVectors(enemy.position, player.position)
              .normalize();
            const angle = playerDir.angleTo(enemyDir);

            if (angle < attackAngle) {
              // HIT!
              const dmg = playerStats.str + ROLES[playerStats.role].baseDmg;
              enemy.userData.hp -= dmg;
              showFloatingText(`-${dmg}`, enemy.position, "red");

              // Pushback ligero
              const push = enemyDir.multiplyScalar(1);
              enemy.position.add(push);

              // Actualizar barra vida enemigo
              const hpPercent = Math.max(
                0,
                enemy.userData.hp / enemy.userData.maxHp
              );
              enemy.userData.hpBar.scale.x = hpPercent;

              if (enemy.userData.hp <= 0) {
                killEnemy(enemy, index);
              }
            }
          }
        });
      }

      function killEnemy(enemy, index) {
        // Robar XP
        const xpGain = enemy.userData.xpReward;
        playerStats.xp += xpGain;
        showFloatingText(`+${xpGain} ALMAS`, player.position, "gold");

        // Eliminar visualmente
        scene.remove(enemy);
        enemies.splice(index, 1);

        updateHUD();

        // Respawn (Simulaci贸n Multijugador)
        setTimeout(() => {
          enemies.push(createCharacter("WARRIOR", true));
        }, 3000);
      }

      function showFloatingText(text, pos, color) {
        const div = document.createElement("div");
        div.innerText = text;
        div.className = color === "gold" ? "xp-text" : "damage-text";
        div.style.color = color;

        // Proyectar posici贸n 3D a 2D
        const vec = pos.clone();
        vec.y += 2;
        vec.project(camera);
        const x = (vec.x * 0.5 + 0.5) * window.innerWidth;
        const y = (-(vec.y * 0.5) + 0.5) * window.innerHeight;

        div.style.left = `${x}px`;
        div.style.top = `${y}px`;
        document.body.appendChild(div);
        setTimeout(() => div.remove(), 1500);
      }

      function toggleStats() {
        const panel = document.getElementById("attr-panel");
        panel.classList.toggle("hidden");
      }

      function upgradeStat(stat) {
        if (playerStats.xp >= 100) {
          playerStats.xp -= 100;
          playerStats[stat]++;
          if (stat === "vig") {
            playerStats.maxHp += 20;
            playerStats.hp = playerStats.maxHp;
          }
          updateHUD();
        }
      }

      function acceptQuest() {
        if (!currentCamp) return;
        currentCamp.userData.used = true;
        currentCamp.children[1].intensity = 0; // Apagar luz

        playerStats.xp += 150;
        playerStats.lvl++;

        const isWarrior = playerStats.role === "WARRIOR";
        if (isWarrior) playerStats.str += 5;
        else playerStats.dex += 5;

        showFloatingText("隆PODER AUMENTADO!", player.position, "yellow");

        closeQuest();
        updateHUD();

        // Bloquear otro campamento
        const others = scene.children.filter(
          (c) => c.userData.isCamp && !c.userData.used
        );
        if (others.length > 0) {
          const blocked = others[Math.floor(Math.random() * others.length)];
          blocked.userData.used = true;
          blocked.children[0].material.color.setHex(0x333333); // Gris visual
        }
      }

      function closeQuest() {
        document.getElementById("quest-notifier").classList.add("hidden");
        currentCamp = null;
      }

      function updateHUD() {
        const hpPct = (playerStats.hp / playerStats.maxHp) * 100;
        document.getElementById("hp-bar").style.width = `${hpPct}%`;
        document.getElementById("hp-text").innerText = `${Math.floor(
          playerStats.hp
        )}/${playerStats.maxHp}`;
        document.getElementById("stamina-bar").style.width = `${
          (playerStats.stamina / playerStats.maxStamina) * 100
        }%`;
        document.getElementById("xp-val").innerText = playerStats.xp;
        document.getElementById("lvl-val").innerText = playerStats.lvl;

        document.getElementById("stat-vig").innerText = playerStats.vig;
        document.getElementById("stat-str").innerText = playerStats.str;
        document.getElementById("stat-dex").innerText = playerStats.dex;

        // Skill Unlock Visual
        const skillBtn = document.getElementById("skill-btn");
        const lockIcon = document.getElementById("lock-icon");
        if (playerStats.lvl >= 2) {
          skillBtn.classList.remove("btn-disabled");
          if (lockIcon) lockIcon.style.display = "none";
        }
      }

      function checkCollisions(newPos) {
        // Colisi贸n con Obst谩culos
        for (let obj of scene.children) {
          if (obj.userData.isObstacle) {
            const dist = newPos.distanceTo(
              new THREE.Vector3(obj.position.x, 0, obj.position.z)
            );
            // Radio jugador (0.5) + Radio objeto
            if (dist < 0.5 + obj.userData.radius) return true;
          }
        }
        // Colisi贸n con Enemigos (Cuerpo a cuerpo)
        for (let en of enemies) {
          const dist = newPos.distanceTo(en.position);
          if (dist < 1.0) return true; // Bloqueo f铆sico
        }
        return false;
      }

      function animate() {
        if (!isGameRunning) return;
        requestAnimationFrame(animate);

        let moveX = joystick.x;
        let moveY = joystick.y;

        // Input PC Override
        if (keys["KeyW"] || keys["ArrowUp"]) moveY = -1;
        if (keys["KeyS"] || keys["ArrowDown"]) moveY = 1;
        if (keys["KeyA"] || keys["ArrowLeft"]) moveX = -1;
        if (keys["KeyD"] || keys["ArrowRight"]) moveX = 1;

        // Movimiento Jugador
        if (moveX !== 0 || moveY !== 0) {
          const speed =
            ROLES[playerStats.role].speed * (1 + playerStats.dex / 50);

          // Vector de movimiento deseado
          const moveVec = new THREE.Vector3(moveX, 0, moveY)
            .normalize()
            .multiplyScalar(speed);

          // Predicci贸n de posici贸n
          const nextPos = player.position.clone().add(moveVec);

          // Chequear colisiones antes de mover
          if (!checkCollisions(nextPos)) {
            player.position.add(moveVec);
          }

          // Rotaci贸n suave
          const targetRotation = Math.atan2(moveX, moveY);
          // Interpolaci贸n simple de rotaci贸n (lerp no es ideal para 谩ngulos pero sirve aqu铆)
          player.rotation.y = targetRotation; // Directa para respuesta r谩pida

          // Huellas
          if (Math.random() > 0.95) {
            const footprint = new THREE.Mesh(
              new THREE.CircleGeometry(0.15, 6),
              new THREE.MeshBasicMaterial({
                color: 0x222222,
                transparent: true,
                opacity: 0.5,
              })
            );
            footprint.rotation.x = -Math.PI / 2;
            footprint.position.set(player.position.x, 0.02, player.position.z);
            scene.add(footprint);
            setTimeout(() => scene.remove(footprint), 5000);
          }
        }

        camera.position.set(
          player.position.x,
          player.position.y + 20,
          player.position.z + 15
        );
        camera.lookAt(player.position);

        if (playerStats.stamina < 100) playerStats.stamina += 0.3;

        // L贸gica Enemigos (Perseguir si cerca)
        enemies.forEach((en) => {
          const dist = en.position.distanceTo(player.position);
          if (dist < 15) {
            // Perseguir jugador
            const dir = new THREE.Vector3()
              .subVectors(player.position, en.position)
              .normalize();
            const nextPos = en.position.clone().addScaledVector(dir, 0.05);

            // Evitar superponerse al jugador
            if (nextPos.distanceTo(player.position) > 1.0) {
              en.position.copy(nextPos);
            }
            en.lookAt(player.position);
          } else {
            // Patrullar
            const dir = new THREE.Vector3()
              .subVectors(en.userData.targetPos, en.position)
              .normalize();
            en.position.addScaledVector(dir, 0.02);
            if (en.position.distanceTo(en.userData.targetPos) < 2) {
              en.userData.targetPos.set(
                (Math.random() - 0.5) * 100,
                0,
                (Math.random() - 0.5) * 100
              );
            }
          }
        });

        // Detecci贸n de Campamentos
        scene.children.forEach((c) => {
          if (c.userData.isCamp && !c.userData.used && !currentCamp) {
            if (player.position.distanceTo(c.position) < 3) {
              currentCamp = c;
              document
                .getElementById("quest-notifier")
                .classList.remove("hidden");
              document.getElementById("quest-title").innerText =
                "CAMPAMENTO DE PODER";
              document.getElementById("quest-desc").innerText =
                "Absorber el poder de este lugar aumentar谩 tu nivel y estad铆sticas dr谩sticamente.";
            }
          }
        });

        renderer.render(scene, camera);
        updateHUD();
      }

      window.onload = initScene;
      window.addEventListener("resize", () => {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
      });
    </script>
  </body>
</html>
